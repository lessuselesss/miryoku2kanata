# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository programmatically generates 135 complete Miryoku keyboard layout configurations for Kanata. All configurations are generated from a single Python script (`generate_configs.py`) that produces Kanata `.kbd` files covering all Miryoku variants:

- 9 alpha layouts (Colemak Mod-DH, QWERTY, Dvorak, Colemak, Colemak Mod-DHk, AZERTY, QWERTZ, Halmak, Workman)
- 3 navigation variants (standard NEIO, vi-style, inverted-T)
- 2 layer configurations (standard, flipped)
- 3 platform clipboard implementations (Linux/Unix, Windows, macOS)

**Key principle**: DO NOT manually edit generated `.kbd` files. Always modify `generate_configs.py` and regenerate.

## Development Workflow

### Using Nix Flake (Primary Development Method)

```bash
# Enter development shell with all tools
nix develop

# Inside devShell, use Mission Control commands:
, generate     # Generate all 135 configurations
, validate     # Validate all configs with Kanata
, test <file>  # Test single config file
,              # Show all available commands

# Or use direct commands:
generate-miryoku-configs
validate-miryoku-configs [PATTERN]
test-miryoku-config <file>
```

### Without Nix

```bash
# Generate all configs
python3 generate_configs.py

# Manually test with Kanata (must be installed)
kanata --check --cfg miryoku-kanata--nix.kbd
```

### Validation with Glob Patterns

```bash
validate-miryoku-configs                              # All configs
validate-miryoku-configs 'miryoku-kanata-qwerty*.kbd' # QWERTY variants
validate-miryoku-configs 'miryoku-kanata-*--mac.kbd'  # All macOS configs
validate-miryoku-configs miryoku-kanata--nix.kbd      # Single file
```

## Architecture

### Code Generation System

The entire configuration set is generated by `generate_configs.py`, which:

1. Defines all variants in data structures (`ALPHAS`, `NAV_VARIANTS`, `PLATFORMS`)
2. Uses a template-based system with layer generation functions
3. Outputs 135 `.kbd` files with self-describing names
4. Enforces constraint: VI navigation is incompatible with FLIP layers (per Miryoku spec)

**Layer structure** (all configs include 10 layers):
- `U_BASE` - Alpha layout with home row mods (tap-hold: 200ms tap, 200ms hold)
- `U_EXTRA` - QWERTY fallback layer (switchable via tap-dance on 'f')
- `U_TAP` - No dual-function keys version of base
- `U_NAV` - Navigation layer (activated by right thumb)
- `U_MOUSE` - Mouse emulation layer
- `U_BUTTON` - Clipboard operations + modifiers
- `U_MEDIA` - Media controls
- `U_NUM` - Numbers/numpad
- `U_SYM` - Symbols (shifted version of NUM)
- `U_FUN` - Function keys

### Configuration Naming Convention

Format: `miryoku-kanata-<alpha>-<modifiers>--<platform>.kbd`

**Rules**:
- Omit components that use defaults
- Default alpha: Colemak Mod-DH (omitted)
- Modifiers in importance order: `flip`, `vi`, `invertedt`
- Platform suffix always included: `nix`, `win`, `mac`

Examples:
- `miryoku-kanata--nix.kbd` → Colemak-DH, standard nav, Linux
- `miryoku-kanata-qwerty-flip--win.kbd` → QWERTY, flipped layers, Windows
- `miryoku-kanata-vi--nix.kbd` → Colemak-DH, vi nav, Linux

### Nix Flake Structure

Uses `flake-parts` architecture with:
- **Mission Control integration** - Provides `,` command task runner in devShell
- **Custom derivations** - Shell script wrappers for Python generator and Kanata validator
- **Checks** - CI-ready validation of all 135 configs
- **Apps** - Standalone executables for generation/validation

The flake defines three custom scripts as derivations:
1. `generateConfigs` - Wraps `python3 generate_configs.py`
2. `validateConfigs` - Iterates configs with `kanata --check`
3. `testConfig` - Tests single config with user-friendly output

## Platform-Specific Details

### Clipboard Key Differences

The generator produces platform-specific clipboard bindings in the `U_BUTTON` layer:

**Linux/Unix** (`--nix`):
- Undo/Redo: `C-z` / `C-S-z`
- Cut/Copy/Paste: `S-del` / `C-ins` / `S-ins`

**Windows** (`--win`):
- Undo/Redo: `C-z` / `C-y` (Windows uses Ctrl+Y for redo)
- Cut/Copy/Paste: `S-del` / `C-ins` / `S-ins`

**macOS** (`--mac`):
- Undo/Redo: `M-z` / `M-S-z` (Meta = Cmd key in Kanata)
- Cut/Copy/Paste: `M-x` / `M-c` / `M-v`

### Navigation Variants

**Standard (default)**: Arrow keys on `NEIO` positions (right hand home row shifted up)
**Vi-style** (`vi`): Arrow keys on `HJKL` positions (shifted one column left from standard)
**Inverted-T** (`invertedt`): Arrow keys arranged in inverted-T shape (down on bottom row)

### Layer Flipping

**Standard**: Left thumb = NAV/MOUSE/MEDIA, Right thumb = NUM/SYM/FUN
**Flipped**: Swaps thumb assignments (useful for one-handed number entry with mouse)

Note: VI navigation cannot be combined with FLIP due to Miryoku specification constraints.

## Reference Implementations

Two reference configs are included:
- `dinaldoap-miryoku.kbd` - Clean, accurate Miryoku port (used as generation template)
- `bogarad-miryoku.kbd` - Heavily customized variant (NOT used, included for comparison)

## Common Tasks

### Adding a New Alpha Layout

1. Add entry to `ALPHAS` dict in `generate_configs.py` with 30-key layout array
2. Run `, generate` to create configs
3. Run `, validate` to ensure all 15 new configs (3 nav × 2 flip × 3 platforms) are valid

### Modifying Layer Behavior

1. Edit the appropriate `generate_*_layer()` function in `generate_configs.py`
2. Changes apply to ALL configs automatically
3. Regenerate and validate all configs

### Testing Changes

```bash
# Generate fresh configs
, generate

# Validate specific subset
, validate 'miryoku-kanata-qwerty*.kbd'  # Test QWERTY only

# Full validation
, validate  # All 135 configs
```

## CI/CD Integration

Use Nix flake checks for automated testing:

```bash
nix flake check  # Generates + validates all configs in sandboxed environment
```

This runs in CI and ensures all configurations remain valid after changes to the generator.
